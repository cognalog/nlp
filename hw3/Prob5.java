import java.io.*;
import java.util.HashMap;

public class Prob5{
	static String eFile;
	static String fFile;
	static String tFile;
	static PrintStream stdout = System.out;

	/*
	* generates keys for a table of q's, t's, or counts
	*/
	public static String makeKey(String ... args){
		String key = "";
		for(int i = 0; i < args.length; i++){
			key += (i + 1 == args.length) ? args[i] : args[i] + "_";
		}
		return key;
	}

	/*
	* gets initial t values from a file generated by Prob4
	*/
	public static HashMap<String, Double> getTs() throws IOException{
		BufferedReader tReader = new BufferedReader(new FileReader(tFile));
		HashMap<String, Double> params = new HashMap();
		String line;
		while((line = tReader.readLine()) != null){
			String[] pair = line.split("~");
			params.put(pair[0], Double.parseDouble(pair[1]));
		}

		return params;
	}

	public static void increment(HashMap<String, Double> counts, double by, String key){
		if(counts.containsKey(key))
			counts.put(key, counts.get(key) + by);
		else
			counts.put(key, by);
	}

	public static HashMap<String, Double> emAlg(int iterations) throws IOException{
		HashMap<String, Double> tAndq = getTs(); //assumes no key conflicts between f_e and i_j_l_m
		HashMap<String, Double> counts = new HashMap();

		for(int its = 1; its <= iterations; its++){
			//reset all stored counts to 0
			for(String k : counts.keySet()){
				counts.put(k, 0.0);
			}
			BufferedReader eReader = new BufferedReader(new FileReader(eFile));
			BufferedReader fReader = new BufferedReader(new FileReader(fFile));
			String eline, fline;
			int k = 1;
			while((eline = eReader.readLine()) != null){
				if(k % 500 == 0)
					stdout.println("on line "+k);
				String[] eWords = eline.split(" ");
				String[] fWords = fReader.readLine().split(" ");//assumes corpora are equally long
				for(int i = 0; i < fWords.length; i++){
					//calculate denominator for delta
					double denom = 0;
					for(int j = 0; j < eWords.length; j++){
						String qKey = makeKey(""+j,""+i,""+eWords.length,""+fWords.length);
						String tKey = makeKey(fWords[i],eWords[j]);
						if(!tAndq.containsKey(qKey))
							tAndq.put(qKey, 1.0 / (eWords.length + 1));
						denom += tAndq.get(qKey) * tAndq.get(tKey);//assumes this t param has been calculated in Prob4
					}
					for(int j = 0; j < eWords.length; j++){
						String qKey = makeKey(""+j,""+i,""+eWords.length,""+fWords.length);
						String tKey = makeKey(fWords[i],eWords[j]);
						//calculate delta
						double delta = (denom > 0) ? tAndq.get(qKey) * tAndq.get(tKey) / denom : 0;
						//increment counts by delta
						String c1 = makeKey(fWords[i],eWords[j]);
						increment(counts,delta,c1);
						increment(counts,delta,eWords[j]);
						String c3 = makeKey(""+j,""+i,""+eWords.length,""+fWords.length);
						increment(counts,delta, c3);
						String c4 = makeKey(""+i,""+eWords.length,""+fWords.length);
						increment(counts,delta,c4);
						//update q and t
						tAndq.put(qKey, counts.get(c3) / counts.get(c4));
						tAndq.put(tKey, counts.get(c1) / counts.get(eWords[j]));
					}
				}
				k++;
			}
		}
		//finally...
		return tAndq;
	}

	public static void main(String[] args) throws IOException{
		if(args.length != 3){
			stdout.println("usage: java Prob5 <english_corpus> <foreign_corpus> <tParams_file>");
			return;
		}
		eFile = args[0];
		fFile = args[1];
		tFile = args[2];

		int i = 0;
		HashMap<String, Double> params = emAlg(1);
		for(String k : params.keySet()){
			if(i >= 10)
				break;
			stdout.println(k+": "+params.get(k));
			i++;
		}
	}
}